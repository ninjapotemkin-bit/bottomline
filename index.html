<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Bottom Line v12 (Pro Edition)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- 1. THEME ENGINE --- */
    :root {
      --bg-body: #000000;
      --bg-surface: #111111;
      --primary: #00E5FF;
      --danger: #FF3B30;
      --warning: #FF9F0A;
      --gold: #FFD60A;
      --purple: #BF5AF2;
      --success: #30D158;
      --text-main: #FFFFFF;
      --text-muted: #8E8E93;
      --radius-L: 28px;
      --radius-M: 18px;
      --nav-h: 70px;
      --nav-gap: 20px;
      --fab-h: 56px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      height: 100dvh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    .mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
    .bold { font-weight: 800; }
    .blur-sensitive.active { filter: blur(8px); transition: filter 0.2s; }
    .text-red { color: var(--danger); }
    .text-teal { color: var(--primary); }
    .text-gold { color: var(--gold); }

    /* --- 2. LAYOUT --- */
    .mobile-frame {
      width: 100%;
      max-width: 480px;
      height: 100dvh;
      background: var(--bg-body);
      position: relative;
      display: flex;
      flex-direction: column;
      border: 1px solid #222;
      overflow: hidden;
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: calc(var(--nav-h) + 100px + env(safe-area-inset-bottom));
      scrollbar-width: none;
    }
    .scroll-area::-webkit-scrollbar { display: none; }

    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px 10px 24px;
      z-index: 50;
    }

    .month-selector {
      display: flex; align-items: center; gap: 10px;
      background: #1a1a1a; padding: 8px 16px; border-radius: 20px;
      border: 1px solid #333;
    }
    .month-arrow { color: var(--text-muted); font-size: 1.2rem; cursor: pointer; padding: 0 5px; }
    .month-label { font-size: 0.9rem; font-weight: 600; width: 140px; text-align: center; }

    .nav-island {
      position: fixed;
      left: 20px; right: 20px;
      height: var(--nav-h);
      bottom: calc(var(--nav-gap) + env(safe-area-inset-bottom));
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 35px;
      display: flex; justify-content: space-around; align-items: center;
      z-index: 100; max-width: 440px; margin: 0 auto;
    }

    .nav-item { display: flex; flex-direction: column; align-items: center; width: 50px; color: #555; cursor: pointer; }
    .nav-item.active { color: var(--primary); }

    /* --- 3. CARDS --- */
    .card { background: var(--bg-surface); border: 1px solid #222; border-radius: var(--radius-L); padding: 24px; margin-bottom: 16px; position: relative; }
    .asset-card { background: linear-gradient(135deg, #1f1c0d 0%, #0d0d0d 100%); border: 1px solid #333; border-radius: var(--radius-L); padding: 24px; margin-bottom: 24px; }
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
    
    .tx-item { display: flex; align-items: center; background: #141414; padding: 16px; border-radius: var(--radius-M); margin-bottom: 8px; }
    .icon-box { width: 44px; height: 44px; border-radius: 14px; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; margin-right: 16px; }
    .icon-inc { color: var(--primary); background: rgba(0, 229, 255, 0.1); }
    .icon-exp { color: var(--danger); background: rgba(255, 59, 48, 0.12); }

    .fab {
      position: fixed; left: 50%; transform: translateX(-50%);
      width: var(--fab-h); height: var(--fab-h); border-radius: 20px;
      background: var(--primary); color: #000; font-size: 2rem;
      display: flex; justify-content: center; align-items: center;
      z-index: 102; cursor: pointer; border: 4px solid #000;
      bottom: calc(var(--nav-gap) + env(safe-area-inset-bottom) + 25px);
    }

    input, select { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 18px; border-radius: 14px; margin-bottom: 16px; }
    .btn { width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 700; cursor: pointer; }
    .btn-primary { background: var(--primary); color: #000; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-glass { background: #222; color: #fff; border: 1px solid #333; }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 200; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }
    .modal-sheet { width: 100%; max-height: 90%; overflow-y: auto; background: #141414; border-radius: 32px 32px 0 0; padding: 30px 24px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    .modal-overlay.open .modal-sheet { transform: translateY(0); }

    .hidden { display: none !important; }
    .label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
    
    .cancel-btn { color: var(--danger); font-size: 0.7rem; font-weight: bold; margin-top: 10px; cursor: pointer; text-decoration: underline; }
  </style>
</head>

<body>
  <div class="mobile-frame">
    <div class="app-header">
      <div class="month-selector">
        <div class="month-arrow" onclick="changeMonth(-1)">‚Äπ</div>
        <div class="month-label" id="lbl-month-display">...</div>
        <div class="month-arrow" onclick="changeMonth(1)">‚Ä∫</div>
      </div>
      <div style="display:flex; gap:15px;">
        <div class="icon-btn" id="btn-privacy" onclick="togglePrivacy()">üëÅÔ∏è</div>
        <div class="icon-btn" onclick="openSettings()">‚öôÔ∏è</div>
      </div>
    </div>

    <div class="scroll-area" id="main-scroll">
      <div id="view-home" class="view-section">
        <div class="card" style="background: linear-gradient(145deg, #1A1A1A, #0d0d0d);">
          <div style="display:flex; justify-content:space-between;">
            <div>
              <div class="label">SAFE TO SPEND</div>
              <div class="mono bold blur-sensitive" style="font-size: 2.8rem; color: var(--primary);" id="disp-safe">‚Ç±0</div>
              <div class="label">ROLLOVER APPLIED: <span class="mono" id="disp-rollover-badge" style="color:var(--success)">‚Ç±0</span></div>
            </div>
            <div style="width:70px; height:70px; position:relative;">
              <canvas id="chart-ring"></canvas>
              <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.7rem; font-weight:bold; color:#666;" id="lbl-ring-pct">0%</div>
            </div>
          </div>
          <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333; display:flex; justify-content:space-between;">
            <div onclick="openIncomeModal()">
              <div class="label">MONTHLY INCOME</div>
              <div class="mono bold blur-sensitive" id="disp-income-val">‚Ç±0</div>
            </div>
            <div style="text-align:right;">
              <div class="label">EXPENSES</div>
              <div class="mono bold blur-sensitive text-red" id="disp-total-exp">‚Ç±0</div>
            </div>
          </div>
        </div>
        <div id="tx-list"></div>
      </div>

      <div id="view-savings" class="view-section hidden">
        <div class="asset-card">
          <div class="label" style="color:var(--gold);">TOTAL BANK BALANCE</div>
          <div class="mono bold blur-sensitive" style="font-size: 2.5rem; color: var(--gold); margin:10px 0;" id="disp-total-liquid">‚Ç±0</div>
          <div class="stat-grid">
            <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:12px;">
              <div class="label" style="color:var(--success);">FREE CASH</div>
              <div class="mono bold blur-sensitive" id="disp-free-cash">‚Ç±0</div>
            </div>
            <div style="background:rgba(0,0,0,0.3); padding:12px; border-radius:12px;">
              <div class="label" style="color:var(--purple);">FROZEN (WISHES)</div>
              <div class="mono bold blur-sensitive" id="disp-frozen-cash">‚Ç±0</div>
            </div>
          </div>
          <button class="btn btn-glass" style="margin-top:20px;" onclick="openAdjustSavings()">Quick Adjust Balance</button>
        </div>
        <div class="section-title">WISHLIST</div>
        <button class="btn btn-glass" style="margin-bottom:15px; border-style:dashed; color:var(--purple);" onclick="openNewJar()">+ New Wish</button>
        <div id="jar-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>
      </div>
    </div>
  </div>

  <div class="nav-island">
    <div class="nav-item active" onclick="switchTab('home', this)">üè†</div>
    <div class="nav-item" onclick="switchTab('savings', this)">üè¶</div>
    <div style="width:40px;"></div>
    <div class="nav-item" onclick="switchTab('bills', this)">üßæ</div>
    <div class="nav-item" onclick="switchTab('search', this)">üîç</div>
  </div>
  <div class="fab" onclick="openNewTx()">+</div>

  <div class="modal-overlay" id="modal-settle">
    <div class="modal-sheet">
      <h2 id="settle-title">Month Ended!</h2>
      <p style="color:#888; margin-bottom:20px;">You have unspent funds from the previous month. How would you like to allocate them?</p>
      
      <div class="card" style="text-align:center;">
        <div class="label">REMAINING BALANCE</div>
        <div class="mono bold" style="font-size:2rem; color:var(--primary);" id="settle-amount">‚Ç±0</div>
      </div>

      <div class="label">1. ADD TO BANK SAVINGS</div>
      <input type="number" id="inp-settle-bank" placeholder="Amount to save (‚Ç±)">
      
      <div class="label">2. ROLLOVER TO NEW MONTH BUDGET</div>
      <input type="number" id="inp-settle-rollover" placeholder="Amount for budget (‚Ç±)">
      
      <button class="btn btn-primary" onclick="confirmSettlement()">Finalize & Start New Month</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-adjust" onclick="closeModal(event, 'modal-adjust')">
    <div class="modal-sheet">
      <h2>Adjust Bank Balance</h2>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn btn-glass" onclick="setAdjustMode('add')">+ Add</button>
        <button class="btn btn-glass" onclick="setAdjustMode('sub')">- Sub</button>
        <button class="btn btn-glass" onclick="setAdjustMode('set')">Set</button>
      </div>
      <input type="number" id="inp-adjust-amt" placeholder="Enter amount...">
      <button class="btn btn-primary" onclick="saveAdjustment()">Apply Change</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-income" onclick="closeModal(event, 'modal-income')">
    <div class="modal-sheet">
      <h2>Monthly Income</h2>
      <p style="color:#666; margin-bottom:15px;">Set your recurring monthly salary/budget.</p>
      <input type="number" id="inp-income-setting" placeholder="‚Ç±0.00">
      <button class="btn btn-primary" onclick="saveIncome()">Save Income</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-tx" onclick="closeModal(event, 'modal-tx')">
    <div class="modal-sheet">
      <h2>New Entry</h2>
      <input type="text" id="inp-tx-title" placeholder="What is this for?">
      <input type="number" id="inp-tx-amt" placeholder="Amount">
      <div style="display:flex; gap:10px;">
        <button class="btn btn-danger" onclick="saveTransaction('exp')">Save Expense</button>
        <button class="btn btn-primary" onclick="saveTransaction('inc')">Save Income</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modal-jar" onclick="closeModal(event, 'modal-jar')">
    <div class="modal-sheet">
      <h2>New Wish</h2>
      <input type="text" id="inp-jar-name" placeholder="Item Name">
      <input type="number" id="inp-jar-target" placeholder="Target Price">
      <button class="btn btn-primary" onclick="saveJar()">Create</button>
    </div>
  </div>

  <script>
    const VERSION = 'bl_pro_v12';
    let data = {
      config: { baseIncome: 0, rollover: 0, privacyMode: false, safePct: 50 },
      transactions: [],
      bills: [],
      jars: [],
      liquidCash: 0,
      currentMonth: "",
      history: []
    };

    let viewDateObj = new Date();
    let viewMonth = "";
    let adjustMode = 'add';
    let chartInstance = null;

    window.onload = () => {
      loadData();
      viewMonth = getMonthLabel(new Date());
      checkMonthCycle();
      renderUI();
    };

    function loadData() {
      const saved = localStorage.getItem(VERSION);
      if (saved) data = JSON.parse(saved);
      if (!data.currentMonth) data.currentMonth = getMonthLabel(new Date());
    }

    function saveData() {
      localStorage.setItem(VERSION, JSON.stringify(data));
      renderUI();
    }

    function getMonthLabel(date) { return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); }

    // --- FIX: MONTHLY ROLLOVER SYSTEM ---
    function checkMonthCycle() {
      const realMonth = getMonthLabel(new Date());
      if (data.currentMonth !== realMonth) {
        // Calculate remaining from the "ghost" month state
        const stats = calculateStats(true); // Get stats for the month that just ended
        
        document.getElementById('settle-title').innerText = `${data.currentMonth} Ended!`;
        document.getElementById('settle-amount').innerText = `‚Ç±${stats.netChange.toLocaleString()}`;
        document.getElementById('inp-settle-rollover').value = Math.max(0, stats.netChange);
        
        openModal('modal-settle');
      }
    }

    function confirmSettlement() {
      const toBank = parseFloat(document.getElementById('inp-settle-bank').value) || 0;
      const toRollover = parseFloat(document.getElementById('inp-settle-rollover').value) || 0;

      // 1. Archive previous month
      data.history.push({
        month: data.currentMonth,
        txs: [...data.transactions],
        finalNet: toBank + toRollover
      });

      // 2. Apply movements
      data.liquidCash += toBank;
      data.config.rollover = toRollover;
      
      // 3. Reset for New Month
      data.transactions = [];
      data.currentMonth = getMonthLabel(new Date());
      
      closeModal(null, 'modal-settle');
      saveData();
      alert("New month started! Rollover applied.");
    }

    // --- MATH ENGINE ---
    function calculateStats(isSettling = false) {
      const activeTxs = data.transactions;
      const incomeTxs = activeTxs.filter(t => t.type === 'inc').reduce((s, t) => s + t.amount, 0);
      const expenseTxs = activeTxs.filter(t => t.type === 'exp').reduce((s, t) => s + t.amount, 0);
      
      const totalIncome = data.config.baseIncome + data.config.rollover + incomeTxs;
      const netChange = totalIncome - expenseTxs;
      
      const safeLimit = totalIncome * (data.config.safePct / 100);
      const safeToSpend = safeLimit - expenseTxs;

      const frozen = data.jars.reduce((s, j) => s + j.saved, 0);

      return {
        income: totalIncome,
        expenses: expenseTxs,
        safe: safeToSpend,
        netChange: netChange,
        liquid: data.liquidCash,
        free: data.liquidCash - frozen,
        frozen: frozen
      };
    }

    // --- SAVINGS ADJUSTMENT ---
    function setAdjustMode(m) { adjustMode = m; }
    function saveAdjustment() {
      const amt = parseFloat(document.getElementById('inp-adjust-amt').value) || 0;
      if (adjustMode === 'add') data.liquidCash += amt;
      else if (adjustMode === 'sub') data.liquidCash -= amt;
      else data.liquidCash = amt;
      
      closeModal(null, 'modal-adjust');
      saveData();
    }

    // --- WISHLIST MANAGEMENT ---
    function saveJar() {
      const name = document.getElementById('inp-jar-name').value;
      const target = parseFloat(document.getElementById('inp-jar-target').value);
      if (name && target) {
        data.jars.push({ name, target, saved: 0 });
        closeModal(null, 'modal-jar');
        saveData();
      }
    }

    function cancelJar(index) {
      if (confirm("Cancel this wish? Any progress made will return to your Free Cash.")) {
        data.jars.splice(index, 1);
        saveData();
      }
    }

    function allocateToJar(i) {
      const jar = data.jars[i];
      const stats = calculateStats();
      const amt = parseFloat(prompt(`Add to ${jar.name}? (Max Free: ‚Ç±${stats.free.toLocaleString()})`));
      if (amt > 0) {
        if (amt > stats.free) return alert("Not enough bank balance!");
        jar.saved += amt;
        saveData();
      }
    }

    // --- UI RENDER ---
    function renderUI() {
      const stats = calculateStats();
      const isCurrent = viewMonth === data.currentMonth;

      document.getElementById('lbl-month-display').innerText = viewMonth;
      document.getElementById('disp-safe').innerText = `‚Ç±${stats.safe.toLocaleString()}`;
      document.getElementById('disp-rollover-badge').innerText = `‚Ç±${data.config.rollover.toLocaleString()}`;
      document.getElementById('disp-income-val').innerText = `‚Ç±${stats.income.toLocaleString()}`;
      document.getElementById('disp-total-exp').innerText = `‚Ç±${stats.expenses.toLocaleString()}`;
      document.getElementById('disp-total-liquid').innerText = `‚Ç±${stats.liquid.toLocaleString()}`;
      document.getElementById('disp-free-cash').innerText = `‚Ç±${stats.free.toLocaleString()}`;
      document.getElementById('disp-frozen-cash').innerText = `‚Ç±${stats.frozen.toLocaleString()}`;

      renderJarList();
      renderTxList();
      updateRingChart(stats);
    }

    function renderJarList() {
      const grid = document.getElementById('jar-grid');
      grid.innerHTML = "";
      data.jars.forEach((jar, i) => {
        const pct = Math.min(100, (jar.saved / jar.target) * 100);
        grid.innerHTML += `
          <div class="card" style="padding:15px; margin:0;" onclick="allocateToJar(${i})">
            <div class="bold">${jar.name}</div>
            <div class="label">‚Ç±${jar.saved.toLocaleString()} / ‚Ç±${jar.target.toLocaleString()}</div>
            <div style="height:4px; background:#333; margin-top:10px; border-radius:2px;">
              <div style="width:${pct}%; height:100%; background:var(--purple);"></div>
            </div>
            <div class="cancel-btn" onclick="event.stopPropagation(); cancelJar(${i})">Cancel Wish</div>
          </div>`;
      });
    }

    function renderTxList() {
      const list = document.getElementById('tx-list');
      list.innerHTML = "";
      data.transactions.forEach((tx, i) => {
        const isExp = tx.type === 'exp';
        list.innerHTML += `
          <div class="tx-item">
            <div class="icon-box ${isExp ? 'icon-exp' : 'icon-inc'}">${isExp ? '‚ñº' : '‚ñ≤'}</div>
            <div style="flex:1">
              <div class="bold">${tx.title}</div>
              <div class="label">${new Date(tx.date).toLocaleDateString()}</div>
            </div>
            <div class="mono bold ${isExp ? 'text-red' : 'text-teal'}">${isExp ? '-' : '+'}‚Ç±${tx.amount.toLocaleString()}</div>
          </div>`;
      });
    }

    function updateRingChart(stats) {
      const ctx = document.getElementById('chart-ring').getContext('2d');
      const pct = stats.income > 0 ? Math.round((stats.expenses / stats.income) * 100) : 0;
      document.getElementById('lbl-ring-pct').innerText = pct + "%";
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          datasets: [{
            data: [stats.expenses, Math.max(0, stats.income - stats.expenses)],
            backgroundColor: ['#FF3B30', '#30D158'],
            borderWidth: 0
          }]
        },
        options: { cutout: '85%', plugins: { legend: { display: false } } }
      });
    }

    // --- NAVIGATION & UTILS ---
    function switchTab(viewId, el) {
      document.querySelectorAll('.view-section').forEach(v => v.classList.add('hidden'));
      document.getElementById(`view-${viewId}`).classList.remove('hidden');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      el.classList.add('active');
    }

    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(e, id) { if (!e || e.target.id === id) document.getElementById(id).classList.remove('open'); }
    function openNewTx() { openModal('modal-tx'); }
    function openIncomeModal() { openModal('modal-income'); }
    function openNewJar() { openModal('modal-jar'); }
    function openAdjustSavings() { openModal('modal-adjust'); }
    
    function saveIncome() {
      data.config.baseIncome = parseFloat(document.getElementById('inp-income-setting').value) || 0;
      closeModal(null, 'modal-income');
      saveData();
    }

    function saveTransaction(type) {
      const title = document.getElementById('inp-tx-title').value;
      const amt = parseFloat(document.getElementById('inp-tx-amt').value);
      if (amt) {
        data.transactions.unshift({ title, amount: amt, type, date: new Date().toISOString() });
        document.getElementById('inp-tx-title').value = "";
        document.getElementById('inp-tx-amt').value = "";
        closeModal(null, 'modal-tx');
        saveData();
      }
    }

    function changeMonth(dir) {
      viewDateObj.setMonth(viewDateObj.getMonth() + dir);
      viewMonth = getMonthLabel(viewDateObj);
      renderUI();
    }
  </script>
</body>
</html>
