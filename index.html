<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Bottom Line v18 (Entrepreneur Edition)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* --- 1. THEME ENGINE (True Black OLED) --- */
    :root {
      --bg-body: #000000;
      --bg-surface: #111111;

      --primary: #00E5FF;    /* Teal */
      --danger: #FF3B30;     /* Red */
      --warning: #FF9F0A;    /* Orange */
      --gold: #FFD60A;       /* Yellow */
      --purple: #BF5AF2;     /* Purple */
      --success: #30D158;    /* Green */

      --text-main: #FFFFFF;
      --text-muted: #8E8E93;

      --radius-L: 28px;
      --radius-M: 18px;

      --nav-h: 70px;
      --nav-gap: 20px;
      --fab-h: 56px;
      --fab-gap: 45px;
    }

    /* --- 2. GLOBAL RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      height: 100dvh;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
    }

    .mono { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
    .bold { font-weight: 800; }
    .blur-sensitive.active { filter: blur(8px); transition: filter 0.2s; }

    .text-red { color: var(--danger); }
    .text-teal { color: var(--primary); }
    .text-gold { color: var(--gold); }

    /* --- 3. LAYOUT --- */
    .mobile-frame {
      width: 100%;
      max-width: 480px;
      height: 100dvh; 
      background: var(--bg-body);
      position: relative;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 60px rgba(0,229,255,0.05);
      border: 1px solid #222;
      overflow: hidden;
    }

    .scroll-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      padding-bottom: calc(var(--nav-h) + var(--nav-gap) + var(--fab-h) + 40px + env(safe-area-inset-bottom));
      scrollbar-width: none;
    }
    .scroll-area::-webkit-scrollbar { display: none; }

    /* --- 4. HEADER & NAV --- */
    .app-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px 10px 24px;
      background: linear-gradient(180deg, #000 0%, rgba(0,0,0,0) 100%);
      z-index: 50;
    }

    .month-selector {
      display: flex; align-items: center; gap: 10px;
      background: #1a1a1a; padding: 8px 16px; border-radius: 20px;
      border: 1px solid #333;
    }
    .month-arrow { color: var(--text-muted); font-size: 1.2rem; cursor: pointer; padding: 0 5px; }
    .month-label { font-size: 0.9rem; font-weight: 600; width: 140px; text-align: center; }

    .icon-btn { font-size: 1.2rem; color: var(--text-muted); cursor: pointer; transition: color 0.2s; }
    .icon-btn.active { color: var(--primary); text-shadow: 0 0 10px var(--primary); }

    .nav-island {
      position: fixed;
      left: 20px; right: 20px;
      height: var(--nav-h);
      bottom: calc(var(--nav-gap) + env(safe-area-inset-bottom));
      background: rgba(20, 20, 20, 0.9);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 35px;
      display: flex; justify-content: space-around; align-items: center;
      z-index: 100; padding: 0 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      max-width: 440px;
      margin: 0 auto;
    }

    .nav-item { display: flex; flex-direction: column; align-items: center; width: 50px; color: #555; transition: color 0.2s; cursor: pointer; }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 1.4rem; }

    /* --- 5. CARDS & WIDGETS --- */
    .card {
      background: var(--bg-surface);
      border: 1px solid #222;
      border-radius: var(--radius-L);
      padding: 24px;
      margin-bottom: 16px;
      position: relative; overflow: hidden;
    }

    .asset-card {
      background: linear-gradient(135deg, #1f1c0d 0%, #0d0d0d 100%);
      border: 1px solid #333; border-radius: var(--radius-L);
      padding: 24px; margin-bottom: 24px;
    }

    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #333; }
    .stat-box { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; }

    .label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; display: block; }
    .section-title { font-size: 0.75rem; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; margin: 24px 0 12px 5px; }

    /* --- 6. LIST ITEMS --- */
    .tx-item {
      display: flex; align-items: center;
      background: #141414; padding: 16px; border-radius: var(--radius-M);
      margin-bottom: 8px; border: 1px solid transparent;
    }

    .trophy-item {
      display: flex; align-items: center; opacity: 0.6;
      background: #111; padding: 16px; border-radius: var(--radius-M);
      margin-bottom: 8px; border: 1px solid #222;
    }

    .icon-box {
      width: 44px; height: 44px; border-radius: 14px;
      display: flex; justify-content: center; align-items: center;
      font-size: 1.4rem; margin-right: 16px; background: #1a1a1a;
    }
    .icon-inc { color: var(--primary); background: rgba(0, 229, 255, 0.1); }
    .icon-exp { color: var(--danger); background: rgba(255, 59, 48, 0.12); }
    /* Style for an asset transaction */
    .icon-asset { color: var(--gold); background: rgba(255, 214, 10, 0.12); } 

    /* --- 7. FAB & INPUTS --- */
    .fab {
      position: fixed;
      left: 50%; transform: translateX(-50%);
      width: var(--fab-h); height: var(--fab-h); border-radius: 20px;
      background: var(--primary); color: #000; font-size: 2rem;
      display: flex; justify-content: center; align-items: center;
      box-shadow: 0 0 20px rgba(0, 229, 255, 0.4);
      z-index: 102; cursor: pointer; transition: transform 0.2s; border: 4px solid #000;
      bottom: calc(var(--nav-gap) + env(safe-area-inset-bottom) + 25px);
    }
    .fab:active { transform: translateX(-50%) scale(0.9); }

    input, select {
      width: 100%; background: #000; border: 1px solid #333;
      color: #fff; padding: 18px; border-radius: 14px;
      font-size: 1rem; margin-bottom: 16px; font-family: 'JetBrains Mono', monospace;
    }
    input:focus, select:focus { border-color: var(--primary); }

    .btn {
      width: 100%; padding: 18px; border-radius: 16px; border: none;
      font-weight: 700; font-size: 1rem; cursor: pointer; display: flex; justify-content: center; align-items: center;
      transition: transform 0.1s;
    }
    .btn-primary { background: var(--primary); color: #000; }
    .btn-glass { background: #222; color: #fff; border: 1px solid #333; }
    .btn-claim { background: linear-gradient(135deg, #FFD60A, #FF9F0A); color: #000; box-shadow: 0 0 15px rgba(255, 214, 10, 0.4); }
    .btn-danger { background: var(--danger); color: #fff; }

    /* Toggle switch style */
    .toggle-container { display: flex; align-items: center; justify-content: space-between; background: #1a1a1a; padding: 12px 18px; border-radius: 14px; border: 1px solid #333; margin-bottom: 16px; cursor: pointer; }
    .toggle-switch { width: 44px; height: 24px; background: #333; border-radius: 12px; position: relative; transition: background 0.3s; }
    .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: transform 0.3s; }
    .toggle-container.active .toggle-switch { background: var(--gold); }
    .toggle-container.active .toggle-switch::after { transform: translateX(20px); }

    /* --- 8. MODALS & UTILS --- */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
      z-index: 200; display: flex; align-items: flex-end;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .modal-overlay.open { opacity: 1; pointer-events: auto; }

    .modal-sheet {
      width: 100%; max-height: 90%; overflow-y: auto;
      background: #141414; border-radius: 32px 32px 0 0;
      padding: 30px 24px; border-top: 1px solid #333;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }
    .modal-overlay.open .modal-sheet { transform: translateY(0); }

    .hidden { display: none !important; }
    .view-section { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .cat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .cat-opt { background: #222; border-radius: 14px; padding: 12px; text-align: center; font-size: 1.6rem; cursor: pointer; border: 2px solid transparent; }
    .cat-opt.selected { background: rgba(0, 229, 255, 0.15); border-color: var(--primary); transform: scale(1.05); }

    .preset-row { display: flex; gap: 10px; margin-bottom: 14px; }
    .chip {
      flex: 1; padding: 10px 0; border-radius: 14px; background: #1f1f1f;
      border: 1px solid #333; color: #ddd; font-weight: 800; cursor: pointer; text-align: center;
    }
    .chip:active { transform: scale(0.98); }

    .jar-cancel-btn {
      position: absolute; top: 12px; right: 15px; color: #888; cursor: pointer; font-size: 1.2rem; z-index: 10;
    }
  </style>
</head>

<body>
  <div class="mobile-frame">

    <div class="app-header">
      <div class="month-selector">
        <div class="month-arrow" onclick="changeMonth(-1)">‚Äπ</div>
        <div class="month-label" id="lbl-month-display">...</div>
        <div class="month-arrow" onclick="changeMonth(1)">‚Ä∫</div>
      </div>
      <div style="display:flex; gap:15px;">
        <div class="icon-btn" id="btn-privacy" onclick="togglePrivacy()">üëÅÔ∏è</div>
        <div class="icon-btn" onclick="openSettings()">‚öôÔ∏è</div>
      </div>
    </div>

    <div class="scroll-area" id="main-scroll">

      <div id="view-home" class="view-section">
        <div class="card" style="background: linear-gradient(145deg, #1A1A1A, #0d0d0d); padding: 24px; position:relative;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
              <div class="label">SAFE TO SPEND</div>
              <div class="mono bold blur-sensitive" style="font-size: 2.8rem; color: var(--primary); margin: 5px 0;" id="disp-safe">‚Ç±0</div>
              <div class="label" style="margin-top:5px;">DAILY BURN RATE: <span class="mono blur-sensitive" style="color:#fff;" id="disp-daily">‚Ç±0</span></div>
            </div>

            <div style="width:70px; height:70px; position:relative; cursor:pointer;" onclick="openSettings()" title="Set Budget Limit">
              <canvas id="chart-ring"></canvas>
              <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.7rem; font-weight:bold; color:#666;"
                   id="lbl-ring-pct">0%</div>
            </div>
          </div>

          <div style="margin-top:20px; padding-top:20px; border-top:1px solid #333; display:flex; justify-content:space-between;">
            <div onclick="openIncomeModal()" style="cursor:pointer;">
              <div class="label">TOTAL FUNDING</div>
              <div class="mono bold blur-sensitive" id="disp-income-val">‚Ç±0</div>
            </div>
            <div style="text-align:right;">
              <div class="label">EXPENSES</div>
              <div class="mono bold blur-sensitive text-red" id="disp-total-exp">‚Ç±0</div>
            </div>
          </div>
        </div>

        <div class="card" style="background: #111; padding: 15px 24px; margin-bottom: 24px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div class="label">SURVIVAL RUNWAY</div>
            <div style="font-size:0.8rem; color:#888;">Based on 3-month avg spend</div>
          </div>
          <div class="mono bold blur-sensitive" style="font-size: 1.5rem; color: var(--primary);" id="disp-runway">-- mo</div>
        </div>

        <div class="section-title">ACTIVITY</div>
        <div id="tx-list"></div>
      </div>

      <div id="view-savings" class="view-section hidden">
        <div class="asset-card">
          <div class="label" style="color:var(--gold);">TOTAL LIQUIDITY (BANK)</div>
          <div class="mono bold blur-sensitive" style="font-size: 2.5rem; color: var(--gold); margin:10px 0;" id="disp-total-liquid">‚Ç±0</div>

          <div class="stat-grid">
            <div class="stat-box">
              <div class="label" style="color:var(--success);">FREE CASH</div>
              <div class="mono bold blur-sensitive" style="font-size:1.1rem; color:var(--success);" id="disp-free-cash">‚Ç±0</div>
            </div>
            <div class="stat-box">
              <div class="label" style="color:var(--purple);">FROZEN (WISHES)</div>
              <div class="mono bold blur-sensitive" style="font-size:1.1rem; color:var(--purple);" id="disp-frozen-cash">‚Ç±0</div>
            </div>
          </div>

          <div id="div-update-bank-btn">
            <button class="btn btn-glass" style="margin-top:20px; font-size:0.8rem;" onclick="openAdjustSavings()">Update Bank Balance</button>
          </div>
        </div>

        <div class="section-title">ACTIVE WISH JARS</div>
        <button class="btn btn-glass" style="margin-bottom:15px; border-style:dashed; color:var(--purple); border-color:var(--purple);" id="btn-new-wish" onclick="openNewJar()">+ New Wish</button>
        <div id="jar-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>

        <div class="section-title" style="margin-top:40px;">ASSET LOCKER</div>
        <div id="asset-list"></div>

        <div class="section-title" style="margin-top:40px;">TROPHY ROOM (COMPLETED)</div>
        <div id="trophy-list"></div>
      </div>

      <div id="view-bills" class="view-section hidden">
        <div class="section-title">TIMELINE</div>
        <div id="timeline-scroll" style="display:flex; overflow-x:auto; gap:8px; padding-bottom:15px; margin-bottom:15px;"></div>
        <div class="section-title">RECURRING BILLS</div>
        <div id="bill-list"></div>
        <button class="btn btn-glass" style="margin-top:20px; border-style:dashed;" onclick="openNewBill()">+ Add Bill</button>
      </div>

      <div id="view-search" class="view-section hidden">
        <input type="text" id="inp-search" placeholder="üîç Search..." onkeyup="runSearch(this.value)">
        <div id="search-results"></div>
      </div>

    </div>

  </div>

  <div class="nav-island">
    <div class="nav-item active" onclick="switchTab('home', this)"><div class="nav-icon">üè†</div></div>
    <div class="nav-item" onclick="switchTab('savings', this)"><div class="nav-icon">üè¶</div></div>
    <div style="width:40px;"></div>
    <div class="nav-item" onclick="switchTab('bills', this)"><div class="nav-icon">üßæ</div></div>
    <div class="nav-item" onclick="switchTab('search', this)"><div class="nav-icon">üîç</div></div>
  </div>
  <div class="fab" id="main-fab" onclick="openNewTx()">+</div>

  <div class="modal-overlay" id="modal-settle" onclick="closeModal(event, 'modal-settle')">
    <div class="modal-sheet">
      <h2>Month Settlement</h2>
      <p style="color:#888; margin-bottom:20px;">You have unspent funds from the previous month. Let's allocate them before starting the new month.</p>
      
      <div class="card" style="text-align:center;">
        <div class="label">UNSPENT BUDGET REMAINING</div>
        <div class="mono bold" style="font-size:2rem; color:var(--primary);" id="disp-settle-unspent">‚Ç±0</div>
      </div>

      <div class="label">1. ADD TO SAVINGS / BANK</div>
      <input type="number" id="inp-settle-save" placeholder="Amount to send to Bank">
      
      <div class="label">2. ROLLOVER TO NEW MONTH BUDGET</div>
      <input type="number" id="inp-settle-roll" placeholder="Amount to add to current budget">

      <button class="btn btn-primary" onclick="processSettlement()">Finalize & Start New Month</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-jar" onclick="closeModal(event, 'modal-jar')">
    <div class="modal-sheet">
      <h2>New Smart Wish</h2>
      <input type="text" id="inp-jar-name" placeholder="Item Name (e.g. Gaming Rig)">
      <input type="number" id="inp-jar-target" placeholder="Target Cost (‚Ç±)">
      <div class="label" style="margin-top:10px;">GOAL DATE (DEADLINE)</div>
      <input type="date" id="inp-jar-date" style="font-family:'Inter', sans-serif;">
      
      <div class="label" style="margin-top:10px;">VAULT INTERCEPT RULE</div>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <select id="inp-jar-ruletype" style="margin-bottom:0; font-size:0.9rem;">
          <option value="none">No Auto-Fund</option>
          <option value="pct">Take Percentage (%)</option>
          <option value="fixed">Take Fixed (‚Ç±)</option>
        </select>
        <input type="number" id="inp-jar-ruleamt" placeholder="Value" style="margin-bottom:0;">
      </div>
      <p style="font-size:0.7rem; color:#666; margin-bottom:20px;">When you add money to your Bank Vault, this rule will automatically slice off your selected amount and put it toward this goal.</p>
      
      <button class="btn btn-primary" style="background:var(--purple); color:white;" onclick="saveJar()">Create Wish</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-manage-jar" onclick="closeModal(event, 'modal-manage-jar')">
    <div class="modal-sheet">
      <h2 id="manage-jar-title">Manage Wish</h2>
      <input type="hidden" id="manage-jar-index">
      
      <div class="label" style="margin-top:10px;">ADJUST SAVED AMOUNT (‚Ç±)</div>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn btn-glass" style="padding:10px; border-color:transparent;" id="btn-jar-adj-add" onclick="setJarAdjMode('add')">+ Add</button>
        <button class="btn btn-glass" style="padding:10px; border-color:transparent;" id="btn-jar-adj-sub" onclick="setJarAdjMode('sub')">- Minus</button>
        <button class="btn btn-glass" style="padding:10px; border-color:var(--primary);" id="btn-jar-adj-set" onclick="setJarAdjMode('set')">Set Total</button>
      </div>
      <input type="text" id="inp-manage-jar-saved" placeholder="Amount">

      <div class="label" style="margin-top:10px;">EDIT TARGET COST (‚Ç±)</div>
      <input type="number" id="inp-manage-jar-target">

      <div class="label" style="margin-top:10px;">EDIT GOAL DATE</div>
      <input type="date" id="inp-manage-jar-date" style="font-family:'Inter', sans-serif;">
      
      <div class="label" style="margin-top:10px;">EDIT VAULT INTERCEPT RULE</div>
      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <select id="inp-manage-jar-ruletype" style="margin-bottom:0; font-size:0.9rem;">
          <option value="none">No Auto-Fund</option>
          <option value="pct">Take Percentage (%)</option>
          <option value="fixed">Take Fixed (‚Ç±)</option>
        </select>
        <input type="number" id="inp-manage-jar-ruleamt" placeholder="Value" style="margin-bottom:0;">
      </div>
      
      <button class="btn btn-primary" style="background:var(--purple); color:white; margin-bottom:10px;" onclick="updateJar()">Save Changes</button>
      <button class="btn btn-glass" style="color:var(--danger); border-color:var(--danger);" onclick="deleteJarFromManage()">Delete Wish</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-tx" onclick="closeModal(event, 'modal-tx')">
    <div class="modal-sheet">
      <h2>New Entry</h2>
      <div style="background:#222; padding:4px; border-radius:14px; display:flex; margin-bottom:20px;">
        <div id="btn-type-exp" class="btn" onclick="setTxType('exp')">Expense</div>
        <div id="btn-type-inc" class="btn" onclick="setTxType('inc')">Income</div>
      </div>
      
      <div id="inc-stream-select" class="hidden" style="margin-bottom:15px;">
        <div class="label">INCOME SOURCE</div>
        <select id="inp-tx-stream">
          <option value="Salary">Salary / Job</option>
          <option value="Agency">Agency / Freelance</option>
          <option value="Content">Content / YouTube</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="cat-grid" id="cat-list"></div>
      <input type="text" id="inp-tx-title" placeholder="Note">
      
      <p style="color:#666; font-size:0.8rem; margin-bottom:5px;">Amount (You can use math like 150+50)</p>
      <input type="text" id="inp-tx-amt" placeholder="Amount (e.g. 500 or 250*2)">
      
      <div id="asset-toggle-container" class="toggle-container" onclick="toggleAssetMode()">
        <div>
          <div style="font-weight:600; font-size:0.9rem;">Mark as Asset</div>
          <div style="font-size:0.7rem; color:#888;">(Deducts from Bank, not Budget)</div>
        </div>
        <div class="toggle-switch"></div>
      </div>

      <button class="btn btn-primary" id="btn-save-tx" onclick="saveTransaction()">SAVE</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-adjust" onclick="closeModal(event, 'modal-adjust')">
    <div class="modal-sheet">
      <h2>Update Bank Balance</h2>
      <p style="color:#666; margin-bottom:15px;">Adjust your liquid cash.</p>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn btn-glass" style="padding:10px; border-color:transparent;" id="btn-adj-add" onclick="setAdjMode('add')">+ Add</button>
        <button class="btn btn-glass" style="padding:10px; border-color:transparent;" id="btn-adj-sub" onclick="setAdjMode('sub')">- Minus</button>
        <button class="btn btn-glass" style="padding:10px; border-color:var(--primary);" id="btn-adj-set" onclick="setAdjMode('set')">Set Total</button>
      </div>
      <input type="text" id="inp-adjust-amt" placeholder="Enter Amount">
      <button class="btn btn-primary" onclick="saveAdjustment()">Apply Update</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-settings" onclick="closeModal(event, 'modal-settings')">
    <div class="modal-sheet">
      <h2>Settings</h2>
      <div class="label">BUDGET SAFE LIMIT</div>
      <div class="preset-row">
        <div class="chip" onclick="setSafePct(30)">30%</div>
        <div class="chip" onclick="setSafePct(40)">40%</div>
        <div class="chip" onclick="setSafePct(50)">50%</div>
        <div class="chip" onclick="setSafePct(60)">60%</div>
        <div class="chip" onclick="setSafePct(70)">70%</div>
      </div>
      <input type="range" id="slider-safe" min="0" max="100" value="50" oninput="updateBudgetSlider(this.value)">
      <div style="text-align:right; font-weight:bold; color:var(--primary); margin-bottom:20px;" id="lbl-safe-pct">50%</div>
      <button class="btn btn-glass" onclick="exportData()">üì§ Backup Data</button>
      <div style="margin-top:10px;">
        <input type="text" id="inp-import" placeholder="Paste backup code...">
        <button class="btn btn-primary" onclick="importData()">üì• Restore</button>
      </div>
      <button class="btn btn-glass" style="margin-top:20px; color:var(--danger); border-color:var(--danger);" onclick="hardReset()">Factory Reset</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-income" onclick="closeModal(event, 'modal-income')">
    <div class="modal-sheet">
      <h2>Fund Your Month</h2>
      <p style="color:#666; margin-bottom:20px;">Choose how to fund your current budget.</p>

      <div class="label">1. RECURRING BASELINE</div>
      <p style="font-size:0.75rem; color:#555; margin-bottom:10px;">Expected monthly fixed income (Leave at 0 if fully variable).</p>
      <input type="text" id="inp-income-setting" placeholder="Monthly Base Income">
      <button class="btn btn-glass" onclick="saveIncome()">Set Baseline</button>

      <div style="margin: 25px 0; border-top: 1px dashed #333;"></div>

      <div class="label">2. PULL FROM SAVINGS</div>
      <p style="font-size:0.75rem; color:#555; margin-bottom:10px;">Move money from your Vault back into your spending budget.</p>
      <input type="text" id="inp-transfer-amt" placeholder="Amount to withdraw (‚Ç±)">
      <button class="btn btn-primary" style="background:var(--warning); color:#000;" onclick="transferFromBank()">Transfer to Budget</button>

      <div style="margin: 25px 0; border-top: 1px dashed #333;"></div>

      <div class="label" style="color:var(--danger);">3. FIX TYPOS (FUNDING OVERRIDE)</div>
      <p style="font-size:0.75rem; color:#555; margin-bottom:10px;">Made a mistake during Settlement? Manually correct your Rollover here.</p>
      <input type="text" id="inp-rollover-override" placeholder="Correct Rollover Amount (‚Ç±)">
      <button class="btn btn-glass" style="border-color:var(--danger); color:var(--danger);" onclick="overrideRollover()">Apply Correction</button>
    </div>
  </div>

  <div class="modal-overlay" id="modal-bill" onclick="closeModal(event, 'modal-bill')">
    <div class="modal-sheet">
      <h2>New Bill</h2>
      <input type="text" id="inp-bill-name" placeholder="Name">
      <input type="text" id="inp-bill-amt" placeholder="Amount">
      <input type="number" id="inp-bill-day" placeholder="Due Day (1-31)">
      <button class="btn btn-primary" onclick="saveBill()">Save</button>
    </div>
  </div>

  <script>
    // --- 1. CONFIGURATION ---
    const VERSION = 'bl_asset_v11'; 

    const CATEGORIES = {
      exp: [
        { id: 'food', icon: 'üçî', name: 'Food' },
        { id: 'trans', icon: 'üöó', name: 'Transport' },
        { id: 'bill', icon: '‚ö°', name: 'Bills' },
        { id: 'shop', icon: 'üõçÔ∏è', name: 'Shopping' },
        { id: 'ent', icon: 'üé¨', name: 'Ent' },
        { id: 'health', icon: '‚ù§Ô∏è', name: 'Health' },
        { id: 'tech', icon: 'üíª', name: 'Tech' },
        { id: 'misc', icon: 'üí∏', name: 'Misc' }
      ],
      inc: [
        { id: 'sal', icon: 'üí∞', name: 'Salary' },
        { id: 'freelance', icon: '‚ö°', name: 'Freelance' },
        { id: 'gift', icon: 'üéÅ', name: 'Gift' },
        { id: 'invest', icon: 'üìà', name: 'Invest' }
      ]
    };

    // --- 2. DATA STATE ---
    let data = {
      config: { baseIncome: 0, safePct: 50, privacyMode: false, rollover: 0 },
      transactions: [],
      bills: [],
      jars: [],
      trophyRoom: [],
      history: [],
      liquidCash: 0,
      currentMonth: ""
    };

    // Volatile State
    let viewMonth = "";
    let viewDateObj = new Date();
    let isExpense = true;
    let selectedCat = CATEGORIES.exp[0];
    let chartInstance = null;
    let adjMode = 'set';
    let jarAdjMode = 'set';
    let isAssetTx = false;

    // --- 3. STARTUP ---
    window.onload = () => {
      loadData();
      viewMonth = data.currentMonth;
      viewDateObj = new Date(viewMonth + " 1"); 
      if (isNaN(viewDateObj)) viewDateObj = new Date(); 
      checkCycle(); 
      renderUI();
    };

    function loadData() {
      const saved = localStorage.getItem(VERSION);
      if (saved) {
        data = JSON.parse(saved);
        if (!data.trophyRoom) data.trophyRoom = [];
        if (!data.config) data.config = { baseIncome: 0, safePct: 50, privacyMode: false, rollover: 0 };
        if (typeof data.config.rollover === 'undefined') data.config.rollover = 0;
        if (typeof data.config.safePct !== 'number') data.config.safePct = 50;
      } else {
        data.currentMonth = getMonthLabel(new Date());
      }
      if (!data.currentMonth) data.currentMonth = getMonthLabel(new Date());
    }

    function saveData() {
      localStorage.setItem(VERSION, JSON.stringify(data));
      renderUI();
    }

    // --- 4. MATH CORE & TIME MACHINE ---
    function calculateStats() {
      let activeTxs = [];
      let activeIncome = 0;
      let snapshotLiquid = null;

      if (viewMonth === data.currentMonth) {
        activeTxs = data.transactions;
        activeIncome = data.config.baseIncome + (data.config.rollover || 0);
        snapshotLiquid = data.liquidCash;
      } else {
        const archive = data.history.find(h => h.id === viewMonth);
        if (archive) {
          activeTxs = archive.txs;
          activeIncome = archive.stats?.income || 0;
          snapshotLiquid = archive.stats?.bankSnapshot !== undefined ? archive.stats.bankSnapshot : data.liquidCash;
        } else {
          snapshotLiquid = data.liquidCash; 
        }
      }

      // Filter out asset transactions from budget calculations
      const budgetTxs = activeTxs.filter(t => t.type !== 'asset');
      
      const extraInc = budgetTxs.filter(t => t.type === 'inc').reduce((s, t) => s + t.amount, 0);
      const totalIncome = activeIncome + extraInc;
      
      const dailyExp = budgetTxs.filter(t => t.type === 'exp').reduce((s, t) => s + t.amount, 0);
      const billTotal = data.bills.reduce((s, b) => s + b.amount, 0);
      const totalExpenses = dailyExp + billTotal;

      const safePct = clampInt(data.config.safePct, 0, 100);
      const limit = totalIncome * (safePct / 100);
      const safe = limit - totalExpenses;
      const netChange = totalIncome - totalExpenses;

      const frozenCash = data.jars.reduce((s, j) => s + j.saved, 0);
      const freeCash = snapshotLiquid - frozenCash;

      return { income: totalIncome, expenses: totalExpenses, limit, safe, netChange, liquid: snapshotLiquid, frozen: frozenCash, free: freeCash, txs: activeTxs };
    }

    function clampInt(v, min, max) {
      const n = parseInt(v, 10);
      if (Number.isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    // --- RUNWAY CALCULATION ---
    function calculateRunway() {
        // Look at the last 3 months of history + current month
        let totalSpend = 0;
        let monthsCounted = 0;

        // Current month
        const currentBudgetTxs = data.transactions.filter(t => t.type === 'exp');
        if (currentBudgetTxs.length > 0) {
            totalSpend += currentBudgetTxs.reduce((s, t) => s + t.amount, 0);
            monthsCounted++;
        }

        // History
        for (let i = 0; i < Math.min(3, data.history.length); i++) {
            const h = data.history[data.history.length - 1 - i];
            if (h.txs) {
                const histExp = h.txs.filter(t => t.type === 'exp').reduce((s, t) => s + t.amount, 0);
                if (histExp > 0) {
                    totalSpend += histExp;
                    monthsCounted++;
                }
            }
        }

        // Add bills into avg
        const monthlyBills = data.bills.reduce((s, b) => s + b.amount, 0);
        totalSpend += (monthlyBills * monthsCounted);

        if (monthsCounted === 0 || totalSpend === 0) return "--";

        const avgMonthlySpend = totalSpend / monthsCounted;
        const runwayMonths = data.liquidCash / avgMonthlySpend;
        return runwayMonths.toFixed(1);
    }

    // --- 5. SMART WISH ENGINE & VAULT INTERCEPT ---
    function runVaultIntercept(amountAdded) {
      if (amountAdded <= 0 || viewMonth !== data.currentMonth) return;
      let interceptTotal = 0;
      
      data.jars.forEach(jar => {
        if (jar.saved >= jar.target) return; 
        let intercept = 0;
        if (jar.ruleType === 'pct' && jar.ruleAmt > 0) {
          intercept = amountAdded * (jar.ruleAmt / 100);
        } else if (jar.ruleType === 'fixed' && jar.ruleAmt > 0) {
          intercept = jar.ruleAmt; 
        }
        
        intercept = Math.min(intercept, jar.target - jar.saved);
        
        if (intercept > 0 && (interceptTotal + intercept) <= amountAdded) {
           jar.saved += intercept;
           interceptTotal += intercept;
        }
      });

      if (interceptTotal > 0) {
         setTimeout(() => alert(`Vault Intercept: Auto-allocated ‚Ç±${interceptTotal.toLocaleString()} to your active wishes!`), 500);
      }
    }

    function saveJar() {
      const n = document.getElementById('inp-jar-name').value.trim();
      const t = parseFloat(document.getElementById('inp-jar-target').value);
      const goalDate = document.getElementById('inp-jar-date').value;
      const rType = document.getElementById('inp-jar-ruletype').value;
      const rAmt = parseFloat(document.getElementById('inp-jar-ruleamt').value) || 0;

      if (n && t) {
        data.jars.push({ 
          name: n, target: t, saved: 0, 
          dateCreated: new Date().toISOString(),
          goalDate: goalDate || null,
          ruleType: rType, ruleAmt: rAmt 
        });
        closeModal(null, 'modal-jar');
        saveData();
      }
    }

    // NEW: MANAGE WISH LOGIC
    function openManageJar(index) {
        if (viewMonth !== data.currentMonth) return alert("You can only edit wishes in the current month.");
        
        const jar = data.jars[index];
        document.getElementById('manage-jar-index').value = index;
        document.getElementById('manage-jar-title').innerText = `Manage: ${jar.name}`;
        
        document.getElementById('inp-manage-jar-target').value = jar.target;
        if (jar.goalDate) document.getElementById('inp-manage-jar-date').value = jar.goalDate;
        else document.getElementById('inp-manage-jar-date').value = "";
        
        document.getElementById('inp-manage-jar-ruletype').value = jar.ruleType || 'none';
        document.getElementById('inp-manage-jar-ruleamt').value = jar.ruleAmt || '';
        
        setJarAdjMode('set'); // Default
        document.getElementById('inp-manage-jar-saved').value = jar.saved;
        
        openModal('modal-manage-jar');
    }

    function setJarAdjMode(mode) {
      jarAdjMode = mode;
      document.getElementById('btn-jar-adj-add').style.borderColor = mode === 'add' ? 'var(--primary)' : 'transparent';
      document.getElementById('btn-jar-adj-sub').style.borderColor = mode === 'sub' ? 'var(--primary)' : 'transparent';
      document.getElementById('btn-jar-adj-set').style.borderColor = mode === 'set' ? 'var(--primary)' : 'transparent';
      
      const idx = document.getElementById('manage-jar-index').value;
      if (idx !== "") {
          if(mode === 'set') document.getElementById('inp-manage-jar-saved').value = data.jars[idx].saved;
          else document.getElementById('inp-manage-jar-saved').value = "";
      }
    }

    function updateJar() {
        const idx = document.getElementById('manage-jar-index').value;
        if (idx === "") return;
        const jar = data.jars[idx];
        const stats = calculateStats();

        const newTarget = parseFloat(document.getElementById('inp-manage-jar-target').value);
        if (newTarget) jar.target = newTarget;

        jar.goalDate = document.getElementById('inp-manage-jar-date').value || null;
        jar.ruleType = document.getElementById('inp-manage-jar-ruletype').value;
        jar.ruleAmt = parseFloat(document.getElementById('inp-manage-jar-ruleamt').value) || 0;

        // Handle Savings Adjustment
        const rawAmt = document.getElementById('inp-manage-jar-saved').value;
        let adjAmt = 0; try { adjAmt = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) {}
        
        if (!isNaN(adjAmt) && document.getElementById('inp-manage-jar-saved').value !== "") {
            let newSaved = jar.saved;
            let difference = 0;

            if (jarAdjMode === 'add') {
                difference = adjAmt;
                newSaved += adjAmt;
            } else if (jarAdjMode === 'sub') {
                difference = -adjAmt;
                newSaved -= adjAmt;
            } else {
                difference = adjAmt - jar.saved;
                newSaved = adjAmt;
            }

            // Ensure we aren't pulling money out of thin air
            if (difference > 0 && difference > stats.free) {
                return alert("Not enough Free Cash to add that much to the wish!");
            }
            if (newSaved < 0) newSaved = 0; // Prevent negative saved amounts

            jar.saved = newSaved;
        }

        if (jar.saved >= jar.target) {
            if (confirm(`CLAIM REWARD: Buy "${jar.name}" for ‚Ç±${jar.saved.toLocaleString()}?\n\nThis will deduct the amount from your Bank and move it to the Trophy Room.`)) {
                buyWish(idx);
                closeModal(null, 'modal-manage-jar');
                return;
            }
        }

        closeModal(null, 'modal-manage-jar');
        saveData();
    }

    function deleteJarFromManage() {
        const idx = document.getElementById('manage-jar-index').value;
        if (idx !== "") {
            deleteJar(idx);
            closeModal(null, 'modal-manage-jar');
        }
    }

    function deleteJar(index) {
      if (confirm("Cancel this wish? Saved funds will remain in your Free Cash.")) {
        data.jars.splice(index, 1);
        saveData();
      }
    }

    function buyWish(index) {
      const jar = data.jars[index];
      data.liquidCash -= jar.saved;
      data.trophyRoom.unshift({ ...jar, dateBought: new Date().toISOString() });
      data.jars.splice(index, 1);
      saveData();
      alert(`Congratulations! You bought ${jar.name}. It is now in your Trophy Room.`);
    }

    // --- 6. CYCLE ENGINE ---
    function getMonthLabel(date) { return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); }

    function changeMonth(dir) {
      viewDateObj.setMonth(viewDateObj.getMonth() + dir);
      viewMonth = getMonthLabel(viewDateObj);
      renderUI();
    }

    function checkCycle() {
      const realMonth = getMonthLabel(new Date());
      if (data.currentMonth !== realMonth) {
        viewMonth = data.currentMonth; 
        const stats = calculateStats();
        const unspent = Math.max(0, stats.safe);
        document.getElementById('disp-settle-unspent').innerText = `‚Ç± ${unspent.toLocaleString()}`;
        document.getElementById('inp-settle-save').value = unspent; 
        document.getElementById('inp-settle-roll').value = 0;
        openModal('modal-settle');
      }
    }

    function processSettlement() {
      const realMonth = getMonthLabel(new Date());
      const toSave = parseFloat(document.getElementById('inp-settle-save').value) || 0;
      const toRoll = parseFloat(document.getElementById('inp-settle-roll').value) || 0;

      // Legacy auto-support
      const oldAutoTotal = data.jars.reduce((s, j) => s + (j.auto || 0), 0);
      if (oldAutoTotal > 0) {
          data.jars.forEach(j => { if (j.auto) j.saved += j.auto; });
          alert(`Legacy Auto-allocated ‚Ç±${oldAutoTotal} to your wishes.`);
      }

      data.history.push({
        id: data.currentMonth,
        txs: [...data.transactions],
        stats: { income: data.config.baseIncome + (data.config.rollover || 0), bankSnapshot: data.liquidCash }
      });

      data.liquidCash += toSave;
      data.config.rollover = toRoll;

      // Run new Intercept on settlement savings
      if (toSave > 0) runVaultIntercept(toSave);

      data.transactions = [];
      data.currentMonth = realMonth;
      viewMonth = realMonth;

      closeModal(null, 'modal-settle');
      saveData();
    }

    // --- 7. BASIC ACTIONS ---
    function setTxType(type) {
      isExpense = type === 'exp';
      const bE = document.getElementById('btn-type-exp');
      const bI = document.getElementById('btn-type-inc');
      const bS = document.getElementById('btn-save-tx');
      const assetTog = document.getElementById('asset-toggle-container');
      const streamSel = document.getElementById('inc-stream-select');

      if (isExpense) {
        bE.style.background = "var(--danger)"; bE.style.color = "white";
        bI.style.background = "transparent"; bI.style.color = "#666";
        bS.innerText = isAssetTx ? "SAVE ASSET" : "SAVE EXPENSE"; 
        bS.className = isAssetTx ? "btn btn-claim" : "btn btn-danger";
        selectedCat = CATEGORIES.exp[0];
        assetTog.classList.remove('hidden');
        streamSel.classList.add('hidden');
      } else {
        bI.style.background = "var(--primary)"; bI.style.color = "black";
        bE.style.background = "transparent"; bE.style.color = "#666";
        bS.innerText = "SAVE INCOME"; bS.className = "btn btn-primary";
        selectedCat = CATEGORIES.inc[0];
        isAssetTx = false; // Reset asset toggle
        assetTog.classList.remove('active');
        assetTog.classList.add('hidden');
        streamSel.classList.remove('hidden');
      }
      renderCatGrid();
    }

    function toggleAssetMode() {
        if (!isExpense) return;
        isAssetTx = !isAssetTx;
        const tog = document.getElementById('asset-toggle-container');
        const bS = document.getElementById('btn-save-tx');
        if (isAssetTx) {
            tog.classList.add('active');
            bS.innerText = "SAVE ASSET"; bS.className = "btn btn-claim";
        } else {
            tog.classList.remove('active');
            bS.innerText = "SAVE EXPENSE"; bS.className = "btn btn-danger";
        }
    }

    function renderCatGrid() {
      const grid = document.getElementById('cat-list');
      if (!grid) return;
      const cats = isExpense ? CATEGORIES.exp : CATEGORIES.inc;
      if (!selectedCat || !cats.some(c => c.id === selectedCat.id)) selectedCat = cats[0];
      grid.innerHTML = "";
      cats.forEach(cat => {
        const el = document.createElement('div');
        el.className = 'cat-opt' + (selectedCat.id === cat.id ? ' selected' : '');
        el.innerText = cat.icon; el.title = cat.name;
        el.onclick = () => { selectedCat = cat; renderCatGrid(); };
        grid.appendChild(el);
      });
    }

    function saveTransaction() {
      const t = document.getElementById('inp-tx-title').value.trim();
      const rawAmt = document.getElementById('inp-tx-amt').value;
      let a = 0;
      try { a = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch (e) { return alert("Invalid math."); }

      if (a && !isNaN(a)) {
        
        let finalType = isExpense ? 'exp' : 'inc';
        let finalTag = selectedCat.id;

        // Apply Asset logic
        if (isExpense && isAssetTx) {
            finalType = 'asset';
            // Deduct from bank immediately instead of current month's budget
            if (a > data.liquidCash) {
                if(!confirm("Warning: This asset costs more than your current bank balance. Save anyway?")) return;
            }
            data.liquidCash -= a;
        }

        // Apply Income Stream logic
        if (!isExpense) {
            const stream = document.getElementById('inp-tx-stream').value;
            finalTag = stream; // Overwrite the visual category id with the structural stream tag
        }

        data.transactions.unshift({ 
            id: Date.now(), 
            title: t || selectedCat.name, 
            amount: a, 
            type: finalType, 
            catIcon: selectedCat.icon, 
            catId: finalTag, 
            date: new Date().toISOString() 
        });
        
        closeModal(null, 'modal-tx');
        document.getElementById('inp-tx-title').value = ""; document.getElementById('inp-tx-amt').value = "";
        saveData();
      }
    }

    function deleteTx(i) { 
        if (confirm("Delete?")) { 
            // If deleting an asset, refund the bank
            if(data.transactions[i].type === 'asset') {
                data.liquidCash += data.transactions[i].amount;
            }
            data.transactions.splice(i, 1); 
            saveData(); 
        } 
    }

    function saveBill() {
      const n = document.getElementById('inp-bill-name').value.trim();
      const rawAmt = document.getElementById('inp-bill-amt').value;
      let a = 0; try { a = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) {}
      const d = parseInt(document.getElementById('inp-bill-day').value, 10) || 1;
      if (n && a) { data.bills.push({ name: n, amount: a, day: d }); closeModal(null, 'modal-bill'); saveData(); }
    }
    
    function deleteBill(i) { if (confirm("Remove bill?")) { data.bills.splice(i, 1); saveData(); } }

    function setAdjMode(mode) {
      adjMode = mode;
      document.getElementById('btn-adj-add').style.borderColor = mode === 'add' ? 'var(--primary)' : 'transparent';
      document.getElementById('btn-adj-sub').style.borderColor = mode === 'sub' ? 'var(--primary)' : 'transparent';
      document.getElementById('btn-adj-set').style.borderColor = mode === 'set' ? 'var(--primary)' : 'transparent';
    }

    function saveAdjustment() {
      const rawAmt = document.getElementById('inp-adjust-amt').value;
      let a = 0; try { a = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) {}

      if (!isNaN(a)) { 
        if (adjMode === 'add') { data.liquidCash += a; runVaultIntercept(a); }
        else if (adjMode === 'sub') data.liquidCash -= a;
        else data.liquidCash = a;
        
        closeModal(null, 'modal-adjust'); 
        document.getElementById('inp-adjust-amt').value = "";
        saveData(); 
      }
    }

    function saveIncome() { 
      const rawAmt = document.getElementById('inp-income-setting').value;
      let a = 0; try { a = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) {}
      if (!isNaN(a)) { data.config.baseIncome = a; closeModal(null, 'modal-income'); saveData(); }
    }

    function transferFromBank() {
      const rawAmt = document.getElementById('inp-transfer-amt').value;
      let a = 0; try { a = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) {}

      if (a && !isNaN(a) && a > 0) {
        if (a > data.liquidCash) return alert("You don't have that much in your Bank/Savings!");
        data.liquidCash -= a;
        data.transactions.unshift({ id: Date.now(), title: "Transfer from Bank", amount: a, type: 'inc', catIcon: 'üè¶', catId: 'transfer', date: new Date().toISOString() });
        closeModal(null, 'modal-income'); document.getElementById('inp-transfer-amt').value = ""; saveData();
      }
    }

    function overrideRollover() {
      const rawAmt = document.getElementById('inp-rollover-override').value;
      let a = 0; try { a = eval(rawAmt.replace(/[^-()\d/*+.]/g, '')); } catch(e) {}
      if (!isNaN(a)) { data.config.rollover = a; closeModal(null, 'modal-income'); document.getElementById('inp-rollover-override').value = ""; saveData(); }
    }

    function updateBudgetSlider(val) {
      const pct = clampInt(val, 0, 100); data.config.safePct = pct;
      const lbl = document.getElementById('lbl-safe-pct'); if (lbl) lbl.innerText = pct + "%";
      const slider = document.getElementById('slider-safe'); if (slider) slider.value = String(pct);
      saveData();
    }
    function setSafePct(pct) { updateBudgetSlider(pct); }
    function togglePrivacy() { data.config.privacyMode = !data.config.privacyMode; saveData(); }
    function exportData() { navigator.clipboard.writeText(JSON.stringify(data)).then(() => alert("Copied to clipboard! Backup safe.")); }
    function importData() { try { data = JSON.parse(document.getElementById('inp-import').value); saveData(); location.reload(); } catch (e) { alert("Invalid Code"); } }
    function hardReset() { if (confirm("Delete All?")) { localStorage.removeItem(VERSION); location.reload(); } }

    // --- 8. UI RENDER ENGINE ---
    function renderUI() {
      const stats = calculateStats();
      const isCurrentMonth = viewMonth === data.currentMonth;

      document.getElementById('lbl-month-display').innerText = viewMonth;
      document.getElementById('main-fab').style.display = isCurrentMonth ? 'flex' : 'none';
      document.getElementById('div-update-bank-btn').style.display = isCurrentMonth ? 'block' : 'none';
      document.getElementById('btn-new-wish').style.display = isCurrentMonth ? 'block' : 'none';

      const blurElements = document.querySelectorAll('.blur-sensitive');
      if (data.config.privacyMode) {
        blurElements.forEach(el => el.classList.add('active'));
        document.getElementById('btn-privacy').classList.add('active');
      } else {
        blurElements.forEach(el => el.classList.remove('active'));
        document.getElementById('btn-privacy').classList.remove('active');
      }

      document.getElementById('disp-safe').innerText = `‚Ç± ${stats.safe.toLocaleString()}`;
      
      let daysRemaining = 1;
      if (isCurrentMonth) {
         const now = new Date();
         const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
         daysRemaining = Math.max(1, endOfMonth.getDate() - now.getDate() + 1);
      } else {
         const endOfMonth = new Date(viewDateObj.getFullYear(), viewDateObj.getMonth() + 1, 0);
         daysRemaining = endOfMonth.getDate();
      }
      const burnRate = stats.safe > 0 ? (stats.safe / daysRemaining) : 0;
      document.getElementById('disp-daily').innerText = `‚Ç± ${Math.round(burnRate).toLocaleString()}`;
      
      document.getElementById('disp-income-val').innerText = `‚Ç± ${stats.income.toLocaleString()}`;
      document.getElementById('disp-total-exp').innerText = `‚Ç± ${stats.expenses.toLocaleString()}`;

      // Calculate and display runway
      document.getElementById('disp-runway').innerText = calculateRunway() + " mo";

      const safeText = document.getElementById('disp-safe');
      if (stats.safe < 0) safeText.style.color = "var(--danger)";
      else if (stats.limit > 0 && stats.safe < (stats.limit * 0.2)) safeText.style.color = "var(--warning)";
      else safeText.style.color = "var(--primary)";

      document.getElementById('disp-total-liquid').innerText = `‚Ç± ${stats.liquid.toLocaleString()}`;
      document.getElementById('disp-free-cash').innerText = `‚Ç± ${stats.free.toLocaleString()}`;
      document.getElementById('disp-frozen-cash').innerText = `‚Ç± ${stats.frozen.toLocaleString()}`;

      renderJarList();
      renderTrophyList();
      renderTxList(stats.txs);
      renderAssetList(stats.txs); // NEW: Render assets on Savings tab
      renderTimeline();
      renderBillList();
      updateRingChart(stats);

      const slider = document.getElementById('slider-safe'); if (slider) slider.value = String(clampInt(data.config.safePct, 0, 100));
      const lbl = document.getElementById('lbl-safe-pct'); if (lbl) lbl.innerText = `${clampInt(data.config.safePct, 0, 100)}%`;
    }

    function renderJarList() {
      const grid = document.getElementById('jar-grid');
      grid.innerHTML = "";
      const isCurrentMonth = viewMonth === data.currentMonth;

      data.jars.forEach((jar, i) => {
        const pct = Math.min(100, (jar.saved / jar.target) * 100);
        const isReady = jar.saved >= jar.target;

        const actionHtml = isReady && isCurrentMonth
          ? `<button class="btn btn-claim" style="padding:10px; font-size:0.8rem; margin-top:10px;" onclick="event.stopPropagation(); updateJar(${i})">üèÜ CLAIM NOW</button>`
          : `<div style="height:4px; background:#333; margin-top:10px; border-radius:2px; overflow:hidden;"><div style="width:${pct}%; height:100%; background:var(--purple);"></div></div>`;

        // SMART WISH LOGIC RENDER
        const createdStr = jar.dateCreated ? new Date(jar.dateCreated).toLocaleDateString(undefined, {month:'short', year:'2-digit'}) : 'N/A';
        const goalStr = jar.goalDate ? new Date(jar.goalDate).toLocaleDateString(undefined, {month:'short', year:'2-digit'}) : 'No Date';

        let paceHtml = '';
        if (jar.goalDate && !isReady) {
          const msLeft = new Date(jar.goalDate) - new Date();
          const monthsLeft = Math.max(1, Math.ceil(msLeft / (1000 * 60 * 60 * 24 * 30)));
          const neededPerMonth = (jar.target - jar.saved) / monthsLeft;
          if (msLeft < 0) {
             paceHtml = `<div style="font-size:0.6rem; color:var(--danger); margin-top:4px;">‚ö†Ô∏è Overdue</div>`;
          } else {
             paceHtml = `<div style="font-size:0.6rem; color:var(--warning); margin-top:4px;">‚ö†Ô∏è Pace: Need ‚Ç±${Math.ceil(neededPerMonth).toLocaleString()}/mo</div>`;
          }
        } else if (isReady) {
          paceHtml = `<div style="font-size:0.6rem; color:var(--success); margin-top:4px;">‚úÖ Goal Reached!</div>`;
        }

        let ruleHtml = '';
        if (jar.ruleType === 'pct') ruleHtml = `‚ö° Auto: ${jar.ruleAmt}% of bank deposits`;
        else if (jar.ruleType === 'fixed') ruleHtml = `‚ö° Auto: ‚Ç±${jar.ruleAmt.toLocaleString()} of bank deposits`;
        if (ruleHtml) ruleHtml = `<div style="font-size:0.6rem; color:var(--success); margin-top:2px;">${ruleHtml}</div>`;

        grid.innerHTML += `
          <div class="card" style="padding:15px; margin:0; cursor:${isCurrentMonth ? 'pointer' : 'default'}; border:1px solid ${isReady ? 'var(--gold)' : '#333'}; position:relative;" ${isCurrentMonth ? `onclick="openManageJar(${i})"` : ''}>
            <div style="font-size:1.5rem; margin-bottom:5px;">${isReady ? 'üéÅ' : 'üßû'}</div>
            <div class="bold" style="font-size:1rem;">${jar.name}</div>
            <div style="font-size:0.55rem; color:#666; margin-bottom:5px;">${createdStr} ‚ûî ${goalStr}</div>
            <div class="label" style="margin-top:5px; color:#fff;">‚Ç±${jar.saved.toLocaleString()} / ‚Ç±${jar.target.toLocaleString()}</div>
            ${ruleHtml}
            ${paceHtml}
            ${actionHtml}
          </div>`;
      });
    }

    function renderTrophyList() {
      const list = document.getElementById('trophy-list');
      list.innerHTML = "";
      if (data.trophyRoom.length === 0) { list.innerHTML = `<div style="text-align:center; color:#444; font-size:0.8rem;">No completed wishes yet.</div>`; return; }

      data.trophyRoom.forEach(t => {
        let verdictHtml = '';
        if (t.goalDate && t.dateBought) {
           const daysDiff = Math.floor((new Date(t.goalDate) - new Date(t.dateBought)) / (1000 * 60 * 60 * 24));
           if (daysDiff >= 0) verdictHtml = `<div style="font-size:0.65rem; color:var(--success);">Beat goal by ${daysDiff} days!</div>`;
           else verdictHtml = `<div style="font-size:0.65rem; color:#888;">Missed goal by ${Math.abs(daysDiff)} days</div>`;
        }

        list.innerHTML += `
          <div class="trophy-item">
            <div style="font-size:1.5rem; margin-right:15px;">üèÜ</div>
            <div style="flex:1;">
              <div class="bold">${t.name}</div>
              <div class="label" style="margin-bottom:2px;">BOUGHT: ${new Date(t.dateBought).toLocaleDateString()}</div>
              ${verdictHtml}
            </div>
            <div class="mono bold text-gold">-‚Ç±${(t.target ?? t.saved ?? 0).toLocaleString()}</div>
          </div>`;
      });
    }

    // NEW: Asset List Renderer
    function renderAssetList(txs) {
      const list = document.getElementById('asset-list');
      list.innerHTML = "";
      const assets = txs.filter(t => t.type === 'asset');
      
      if (assets.length === 0) {
          list.innerHTML = `<div style="text-align:center; color:#444; font-size:0.8rem;">No assets logged this month.</div>`;
          return;
      }

      assets.forEach(tx => {
          const del = (viewMonth === data.currentMonth) ? `<div style="margin-left:15px; color:#444; cursor:pointer;" onclick="deleteTx(${data.transactions.indexOf(tx)})">‚úï</div>` : '';
          list.innerHTML += `
            <div class="tx-item" style="border: 1px solid rgba(255, 214, 10, 0.3);">
              <div class="icon-box icon-asset">${tx.catIcon || 'üì¶'}</div>
              <div style="flex:1;">
                <div class="bold">${tx.title}</div>
                <div class="label">${new Date(tx.date).toLocaleDateString()}</div>
              </div>
              <div class="mono bold text-gold blur-sensitive">-‚Ç±${tx.amount.toLocaleString()}</div>
              ${del}
            </div>`;
      });
    }

    function renderTxList(txs) {
      const list = document.getElementById('tx-list');
      list.innerHTML = "";
      
      // Filter out assets from the main activity list
      const budgetTxs = txs.filter(t => t.type !== 'asset');

      if (!budgetTxs || budgetTxs.length === 0) { list.innerHTML = `<div style="text-align:center; color:#333; margin-top:30px; font-size:0.9rem;">No data for ${viewMonth}</div>`; return; }

      const groups = {};
      budgetTxs.forEach(tx => {
        const dateKey = new Date(tx.date).toLocaleDateString();
        if (!groups[dateKey]) groups[dateKey] = []; groups[dateKey].push(tx);
      });

      Object.keys(groups).forEach(date => {
        list.innerHTML += `<div class="label" style="margin-top:20px; margin-left:5px;">${date}</div>`;
        groups[date].forEach(tx => {
          const color = tx.type === 'exp' ? 'icon-exp' : 'icon-inc';
          const amtColor = tx.type === 'exp' ? 'text-red' : 'text-teal';
          const sign = tx.type === 'exp' ? '-' : '+';
          const del = (viewMonth === data.currentMonth) ? `<div style="margin-left:15px; color:#444; cursor:pointer;" onclick="deleteTx(${data.transactions.indexOf(tx)})">‚úï</div>` : '';
          
          // Display Income Stream tag if it exists
          let subText = tx.catId ? tx.catId.toUpperCase() : 'GENERAL';

          list.innerHTML += `
            <div class="tx-item">
              <div class="icon-box ${color}">${tx.catIcon || '‚Ä¢'}</div>
              <div style="flex:1;">
                <div class="bold">${tx.title}</div>
                <div class="label">${subText}</div>
              </div>
              <div class="mono bold ${amtColor} blur-sensitive">${sign}‚Ç±${tx.amount.toLocaleString()}</div>
              ${del}
            </div>`;
        });
      });
    }

    function renderTimeline() {
      const container = document.getElementById('timeline-scroll');
      container.innerHTML = "";
      const today = new Date().getDate();

      for (let i = 1; i <= 31; i++) {
        const hasBill = data.bills.some(b => b.day === i);
        let borderColor = i === today ? "var(--primary)" : "#333";
        let textColor = i === today ? "var(--primary)" : "#666";

        if (hasBill) { textColor = "#fff"; borderColor = i < today ? "var(--danger)" : (i === today ? "var(--primary)" : "#555"); }
        container.innerHTML += `
          <div style="min-width: 40px; height: 50px; border: 1px solid ${borderColor}; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: ${hasBill ? 'rgba(255,255,255,0.05)' : 'transparent'}; color: ${textColor};">
            <span style="font-size:0.8rem; font-weight:bold;">${i}</span>
            ${hasBill ? '<div style="width:4px; height:4px; background:currentColor; border-radius:50%; margin-top:2px;"></div>' : ''}
          </div>`;
      }
    }

    function renderBillList() {
      const list = document.getElementById('bill-list');
      list.innerHTML = "";
      const today = new Date().getDate();

      data.bills.slice().sort((a, b) => a.day - b.day).forEach((b, i) => {
        const diff = b.day - today;
        const status = today > b.day ? "Past Due" : (diff <= 3 ? `Due in ${diff} days` : `Due Day ${b.day}`);
        const color = today > b.day ? "#666" : (diff <= 3 ? "var(--warning)" : "var(--primary)");

        list.innerHTML += `
          <div class="card" style="padding:15px; display:flex; justify-content:space-between; align-items:center; border-left:3px solid ${color};">
            <div><div class="bold">${b.name}</div><div class="label" style="color:${color}">${status}</div></div>
            <div style="display:flex; align-items:center;"><span class="mono bold">‚Ç±${b.amount.toLocaleString()}</span><span style="margin-left:15px; color:#444; cursor:pointer;" onclick="deleteBill(${i})">‚úï</span></div>
          </div>`;
      });
    }

    function updateRingChart(stats) {
      const canvas = document.getElementById('chart-ring'); if (!canvas) return;
      const ctx = canvas.getContext('2d');

      const limitForChart = Math.max(1, stats.limit || 0);
      const usedRaw = Math.max(0, stats.expenses || 0);
      const used = Math.min(usedRaw, limitForChart);
      const remaining = Math.max(0, limitForChart - used);

      const usedColor = getComputedStyle(document.documentElement).getPropertyValue('--danger').trim() || '#FF3B30';
      const remainingColor = getComputedStyle(document.documentElement).getPropertyValue('--success').trim() || '#30D158';

      const pctUsed = (stats.limit > 0) ? Math.min(999, Math.round((usedRaw / stats.limit) * 100)) : 0;
      const lblRing = document.getElementById('lbl-ring-pct'); if (lblRing) lblRing.innerText = `${pctUsed}%`;

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: { datasets: [{ data: [used, remaining], backgroundColor: [usedColor, remainingColor], borderWidth: 0, borderRadius: 20 }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '85%', plugins: { legend: { display: false }, tooltip: { enabled: false } }, animation: { duration: 450 } }
      });
    }

    function switchTab(viewId, navEl) {
      document.querySelectorAll('.view-section').forEach(el => { el.classList.add('hidden'); el.style.display = 'none'; });
      const target = document.getElementById(`view-${viewId}`); target.classList.remove('hidden'); target.style.display = 'block';
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); navEl.classList.add('active');
      document.getElementById('main-scroll').scrollTop = 0;
    }

    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(e, id) { if (!e || e.target.id === id) document.getElementById(id).classList.remove('open'); }
    function openNewTx() { 
        isAssetTx = false; // reset
        renderCatGrid(); 
        setTxType(isExpense ? 'exp' : 'inc'); 
        openModal('modal-tx'); 
    }
    function openSettings() {
      const pct = clampInt(data.config.safePct, 0, 100); const slider = document.getElementById('slider-safe'); const lbl = document.getElementById('lbl-safe-pct');
      if (slider) slider.value = String(pct); if (lbl) lbl.innerText = `${pct}%`;
      openModal('modal-settings');
    }
    
    function openIncomeModal() { 
      if (viewMonth !== data.currentMonth) return alert("You can only edit funding for the current month.");
      document.getElementById('inp-income-setting').value = data.config.baseIncome || ""; 
      document.getElementById('inp-rollover-override').value = data.config.rollover || "";
      openModal('modal-income'); 
    }
    
    function openNewBill() { openModal('modal-bill'); }
    function openNewJar() { openModal('modal-jar'); }
    function openAdjustSavings() { openModal('modal-adjust'); }

    function runSearch(q) {
      const res = document.getElementById('search-results'); res.innerHTML = ""; if (!q || q.length < 2) return;
      let matches = [];
      data.transactions.forEach(t => matches.push({ ...t, src: 'Current' }));
      data.history.forEach(h => (h.txs || []).forEach(t => matches.push({ ...t, src: h.id })));
      const needle = q.toLowerCase(); matches = matches.filter(m => (m.title || '').toLowerCase().includes(needle));
      if (matches.length === 0) { res.innerHTML = "<div style='text-align:center;margin-top:20px;color:#666'>No matches</div>"; return; }
      matches.forEach(m => {
        const c = m.type === 'exp' ? 'text-red' : 'text-teal'; const s = m.type === 'exp' ? '-' : '+';
        res.innerHTML += `<div class="tx-item"><div class="bold" style="font-size:1.2rem; margin-right:10px;">${m.catIcon || '‚Ä¢'}</div><div style="flex:1;"><div class="bold">${m.title}</div><div class="label">${m.src}</div></div><div class="mono bold ${c}">${s}‚Ç±${m.amount.toLocaleString()}</div></div>`;
      });
    }
  </script>
</body>
</html>
